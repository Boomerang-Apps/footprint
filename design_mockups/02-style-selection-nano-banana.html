<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Footprint - בחירת סגנון (Nano Banana Test)</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #7c3aed;
      --primary-light: #a78bfa;
      --accent: #ec4899;
      --success: #10b981;
      --error: #ef4444;
      --gray-50: #fafafa;
      --gray-100: #f4f4f5;
      --gray-200: #e4e4e7;
      --gray-300: #d4d4d8;
      --gray-400: #a1a1aa;
      --gray-500: #71717a;
      --gray-600: #52525b;
      --gray-700: #3f3f46;
      --gray-900: #18181b;
      --white: #ffffff;
      --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
      --content-padding: 16px;
      --max-content-width: 1200px;
    }

    body {
      font-family: 'Heebo', system-ui, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    button { cursor: pointer; font-family: inherit; border: none; background: none; }

    .icon {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }
    .icon-sm { width: 18px; height: 18px; }

    /* API Config Panel */
    .api-config {
      background: var(--gray-900);
      color: var(--white);
      padding: 12px var(--content-padding);
      font-size: 13px;
    }
    .api-config-inner {
      max-width: var(--max-content-width);
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .api-config label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .api-config input {
      background: var(--gray-700);
      border: 1px solid var(--gray-600);
      color: var(--white);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      width: 300px;
    }
    .api-config input::placeholder { color: var(--gray-400); }
    .api-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .api-status.ready { background: var(--success); }
    .api-status.error { background: var(--error); }
    .api-status.waiting { background: var(--gray-600); }

    /* Header */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 12px var(--content-padding);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: var(--max-content-width);
      margin: 0 auto;
    }
    .back-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-600);
      border-radius: 12px;
    }
    .header-title { font-size: 17px; font-weight: 600; }
    .header-action { width: 40px; }

    /* Progress */
    .progress {
      background: var(--white);
      padding: 16px var(--content-padding);
      border-bottom: 1px solid var(--gray-200);
    }
    .progress-inner {
      max-width: var(--max-content-width);
      margin: 0 auto;
    }
    .progress-bar {
      height: 4px;
      background: var(--gray-200);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(to left, var(--primary), var(--accent));
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .progress-steps {
      display: flex;
      justify-content: space-between;
    }
    .progress-step {
      font-size: 12px;
      color: var(--gray-400);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .progress-step.active { color: var(--primary); font-weight: 600; }
    .progress-step.completed { color: var(--success); }
    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gray-300);
    }
    .progress-step.active .step-dot { background: var(--primary); }
    .progress-step.completed .step-dot { background: var(--success); }

    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: var(--max-content-width);
      margin: 0 auto;
      padding: 0 var(--content-padding);
      padding-bottom: 100px;
    }

    /* Before/After Comparison */
    .comparison-section {
      padding: 20px 0;
    }
    .comparison-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      aspect-ratio: 4/5;
      background: var(--gray-100);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    .comparison-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .comparison-original {
      z-index: 1;
    }
    .comparison-transformed {
      z-index: 2;
      clip-path: inset(0 0 0 50%);
      transition: clip-path 0.1s ease-out;
    }
    .comparison-slider {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 4px;
      background: var(--white);
      z-index: 10;
      cursor: ew-resize;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .comparison-slider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      background: var(--white);
      border-radius: 50%;
      box-shadow: var(--shadow-md);
    }
    .comparison-slider::after {
      content: '↔';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: var(--gray-600);
    }
    .comparison-label {
      position: absolute;
      bottom: 12px;
      padding: 6px 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 12px;
      font-weight: 600;
      border-radius: 20px;
      z-index: 5;
    }
    .comparison-label.original { left: 12px; }
    .comparison-label.transformed { right: 12px; }

    /* AI Loading Overlay */
    .ai-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      z-index: 20;
    }
    .ai-overlay.show { display: flex; }
    .ai-spinner {
      width: 56px;
      height: 56px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .ai-text { font-size: 15px; color: var(--gray-700); font-weight: 500; text-align: center; }
    .ai-subtext { font-size: 12px; color: var(--gray-500); }

    /* Error State */
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 12px 16px;
      border-radius: 12px;
      margin: 16px 0;
      font-size: 13px;
      display: none;
    }
    .error-message.show { display: block; }

    /* Styles Section */
    .styles-section {
      padding: 20px 0;
    }
    .styles-header {
      margin-bottom: 16px;
      text-align: center;
    }
    .styles-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .styles-subtitle { font-size: 13px; color: var(--gray-500); }

    /* Horizontal Style Strip */
    .styles-strip {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 4px;
    }
    .styles-strip::-webkit-scrollbar { display: none; }

    .style-item {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      scroll-snap-align: start;
    }
    .style-icon-btn {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    .style-icon-btn .icon {
      width: 28px;
      height: 28px;
      color: white;
    }
    .style-item:active .style-icon-btn { transform: scale(0.95); }
    .style-item.selected .style-icon-btn {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.25);
    }
    .style-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-600);
      text-align: center;
      max-width: 70px;
    }
    .style-item.selected .style-name {
      color: var(--primary);
      font-weight: 600;
    }

    /* Style Icon Colors */
    .style-pop-art { background: linear-gradient(135deg, #8b5cf6, #ec4899); }
    .style-watercolor { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
    .style-line-art { background: linear-gradient(135deg, #6b7280, #9ca3af); }
    .style-oil { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .style-romantic { background: linear-gradient(135deg, #ec4899, #f472b6); }
    .style-comic { background: linear-gradient(135deg, #f97316, #ef4444); }
    .style-vintage { background: linear-gradient(135deg, #92400e, #b45309); }
    .style-original { background: linear-gradient(135deg, #10b981, #34d399); }

    /* Selected Check */
    .style-check {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }
    .style-check .icon { width: 12px; height: 12px; color: white; stroke-width: 3; }
    .style-item.selected .style-check { display: flex; }

    /* API Info */
    .api-info {
      margin: 16px 0;
      padding: 12px;
      background: rgba(124, 58, 237, 0.06);
      border-radius: 12px;
      font-size: 12px;
      color: var(--gray-600);
    }
    .api-info code {
      background: var(--gray-200);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }

    /* Bottom CTA */
    .bottom-cta {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      border-top: 1px solid var(--gray-200);
      padding: 12px var(--content-padding);
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    .bottom-inner {
      max-width: var(--max-content-width);
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .btn-primary {
      flex: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: var(--white);
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      box-shadow: var(--shadow-md);
    }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-secondary {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--white);
      border: 2px solid var(--gray-200);
      color: var(--gray-700);
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
    }

    @media (min-width: 640px) {
      :root { --content-padding: 24px; }
      .comparison-container { max-width: 450px; border-radius: 24px; }
      .styles-strip { gap: 16px; justify-content: center; }
      .style-icon-btn { width: 72px; height: 72px; border-radius: 18px; }
    }
  </style>
</head>
<body>
  <svg style="display:none">
    <defs>
      <symbol id="i-arrow-right" viewBox="0 0 24 24"><path d="m9 18 6-6-6-6"/></symbol>
      <symbol id="i-arrow-left" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"/></symbol>
      <symbol id="i-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></symbol>
      <symbol id="i-sparkles" viewBox="0 0 24 24"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/></symbol>
      <symbol id="i-zap" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></symbol>
      <symbol id="i-droplet" viewBox="0 0 24 24"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></symbol>
      <symbol id="i-pen" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></symbol>
      <symbol id="i-brush" viewBox="0 0 24 24"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"/></symbol>
      <symbol id="i-heart" viewBox="0 0 24 24"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></symbol>
      <symbol id="i-film" viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18M17 3v18"/></symbol>
      <symbol id="i-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></symbol>
    </defs>
  </svg>

  <!-- API Config Panel (for testing) -->
  <div class="api-config">
    <div class="api-config-inner">
      <label>
        Google AI API Key:
        <input type="password" id="apiKey" placeholder="Enter your API key..." />
      </label>
      <span class="api-status waiting" id="apiStatus">Waiting for key</span>
      <button onclick="testApiConnection()" style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px;">
        Test Connection
      </button>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <button class="back-btn" onclick="history.back()">
        <svg class="icon"><use href="#i-arrow-right"/></svg>
      </button>
      <h1 class="header-title">בחירת סגנון - Nano Banana Test</h1>
      <div class="header-action"></div>
    </div>
  </header>

  <!-- Progress -->
  <div class="progress">
    <div class="progress-inner">
      <div class="progress-bar">
        <div class="progress-fill" style="width: 40%"></div>
      </div>
      <div class="progress-steps">
        <div class="progress-step completed"><span class="step-dot"></span>העלאה</div>
        <div class="progress-step active"><span class="step-dot"></span>סגנון</div>
        <div class="progress-step"><span class="step-dot"></span>התאמה</div>
        <div class="progress-step"><span class="step-dot"></span>תשלום</div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main">
    <!-- Before/After Comparison -->
    <div class="comparison-section">
      <div class="comparison-container" id="comparisonContainer">
        <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=800&h=1000&fit=crop&crop=face"
             alt="Original" class="comparison-image comparison-original" id="originalImage">
        <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=800&h=1000&fit=crop&crop=face"
             alt="Transformed" class="comparison-image comparison-transformed" id="transformedImage">

        <div class="comparison-slider" id="comparisonSlider"></div>

        <span class="comparison-label original">מקור</span>
        <span class="comparison-label transformed" id="transformedLabel">פופ ארט</span>

        <!-- AI Loading Overlay -->
        <div class="ai-overlay" id="aiOverlay">
          <div class="ai-spinner"></div>
          <span class="ai-text" id="aiText">מעבד עם Nano Banana...</span>
          <span class="ai-subtext">Google Gemini 2.5 Flash Image</span>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Style Strip -->
    <div class="styles-section">
      <div class="styles-header">
        <h2 class="styles-title">בחרו סגנון אמנות</h2>
        <p class="styles-subtitle">הקישו על סגנון לתצוגה מקדימה עם Nano Banana AI</p>
      </div>

      <div class="styles-strip">
        <div class="style-item selected" data-style="pop-art" data-prompt="Transform this photo into bold pop art style with vibrant colors, halftone dots pattern, and Warhol-inspired aesthetic">
          <div class="style-icon-btn style-pop-art">
            <svg class="icon"><use href="#i-zap"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">פופ ארט</span>
        </div>

        <div class="style-item" data-style="watercolor" data-prompt="Transform this photo into a soft watercolor painting with flowing colors, wet edges, and artistic brush strokes">
          <div class="style-icon-btn style-watercolor">
            <svg class="icon"><use href="#i-droplet"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">צבעי מים</span>
        </div>

        <div class="style-item" data-style="line-art" data-prompt="Transform this photo into clean minimalist line art with simple black lines on white background">
          <div class="style-icon-btn style-line-art">
            <svg class="icon"><use href="#i-pen"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">ציור קווי</span>
        </div>

        <div class="style-item" data-style="oil-painting" data-prompt="Transform this photo into a classic oil painting with thick brushstrokes, rich colors, and renaissance painting style">
          <div class="style-icon-btn style-oil">
            <svg class="icon"><use href="#i-brush"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">ציור שמן</span>
        </div>

        <div class="style-item" data-style="romantic" data-prompt="Transform this photo into a romantic dreamy style with soft focus, warm pink tones, and ethereal glow">
          <div class="style-icon-btn style-romantic">
            <svg class="icon"><use href="#i-heart"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">רומנטי</span>
        </div>

        <div class="style-item" data-style="comic-book" data-prompt="Transform this photo into comic book style with bold outlines, bright colors, halftone shading, and action comic aesthetic">
          <div class="style-icon-btn style-comic">
            <svg class="icon"><use href="#i-zap"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">קומיקס</span>
        </div>

        <div class="style-item" data-style="vintage" data-prompt="Transform this photo into vintage retro style with sepia tones, film grain, and nostalgic 1970s photograph look">
          <div class="style-icon-btn style-vintage">
            <svg class="icon"><use href="#i-film"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">וינטג׳</span>
        </div>

        <div class="style-item" data-style="enhanced" data-prompt="Enhance this photo with improved colors, better contrast, and professional photo editing while keeping it realistic">
          <div class="style-icon-btn style-original">
            <svg class="icon"><use href="#i-sun"/></svg>
            <div class="style-check"><svg class="icon"><use href="#i-check"/></svg></div>
          </div>
          <span class="style-name">מקורי משופר</span>
        </div>
      </div>

      <div class="api-info">
        <strong>Nano Banana Test Mode</strong><br>
        Using <code>gemini-2.0-flash-exp</code> model with image generation via Google AI API.<br>
        Enter your API key above and click "Test Connection" to verify.
      </div>
    </div>
  </main>

  <!-- Bottom CTA -->
  <div class="bottom-cta">
    <div class="bottom-inner">
      <button class="btn-secondary" onclick="history.back()">
        <span>חזרה</span>
      </button>
      <button class="btn-primary" id="continueBtn" onclick="window.location.href='03-customize.html'">
        <span>אהבתי! המשך</span>
        <svg class="icon icon-sm"><use href="#i-arrow-left"/></svg>
      </button>
    </div>
  </div>

  <script>
    // Style mapping
    const styleNames = {
      'pop-art': 'פופ ארט',
      'watercolor': 'צבעי מים',
      'line-art': 'ציור קווי',
      'oil-painting': 'ציור שמן',
      'romantic': 'רומנטי',
      'comic-book': 'קומיקס',
      'vintage': 'וינטג׳',
      'enhanced': 'מקורי משופר'
    };

    let currentStyle = 'pop-art';
    let isProcessing = false;

    // Comparison slider functionality
    const slider = document.getElementById('comparisonSlider');
    const container = document.getElementById('comparisonContainer');
    const transformedImg = document.getElementById('transformedImage');

    let isDragging = false;

    function updateSlider(x) {
      const rect = container.getBoundingClientRect();
      let percent = ((x - rect.left) / rect.width) * 100;
      percent = Math.max(0, Math.min(100, percent));

      slider.style.left = percent + '%';
      transformedImg.style.clipPath = `inset(0 0 0 ${percent}%)`;
    }

    slider.addEventListener('mousedown', () => isDragging = true);
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('mousemove', (e) => {
      if (isDragging) updateSlider(e.clientX);
    });

    slider.addEventListener('touchstart', () => isDragging = true);
    document.addEventListener('touchend', () => isDragging = false);
    document.addEventListener('touchmove', (e) => {
      if (isDragging) updateSlider(e.touches[0].clientX);
    });

    // Style selection
    document.querySelectorAll('.style-item').forEach(item => {
      item.addEventListener('click', () => selectStyle(item));
    });

    async function selectStyle(element) {
      if (isProcessing) return;

      const style = element.dataset.style;
      const prompt = element.dataset.prompt;

      // Update UI
      document.querySelectorAll('.style-item').forEach(item => {
        item.classList.remove('selected');
      });
      element.classList.add('selected');

      document.getElementById('transformedLabel').textContent = styleNames[style];
      currentStyle = style;

      // Check if API key is available
      const apiKey = document.getElementById('apiKey').value;
      if (!apiKey) {
        showError('Please enter your Google AI API key to test real transformations');
        // For demo, just show the loading animation briefly
        showLoading(style);
        setTimeout(() => hideLoading(), 1500);
        return;
      }

      // Call Nano Banana API
      await transformImage(prompt, style);
    }

    function showLoading(style) {
      const overlay = document.getElementById('aiOverlay');
      document.getElementById('aiText').textContent = `מעבד בסגנון ${styleNames[style]}...`;
      overlay.classList.add('show');
      isProcessing = true;
    }

    function hideLoading() {
      document.getElementById('aiOverlay').classList.remove('show');
      isProcessing = false;
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('show');
      setTimeout(() => errorEl.classList.remove('show'), 5000);
    }

    async function testApiConnection() {
      const apiKey = document.getElementById('apiKey').value;
      const statusEl = document.getElementById('apiStatus');

      if (!apiKey) {
        statusEl.textContent = 'No key';
        statusEl.className = 'api-status error';
        return;
      }

      statusEl.textContent = 'Testing...';
      statusEl.className = 'api-status waiting';

      try {
        // Test connection by checking if Gemini 2.0 Flash model is available
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp?key=${apiKey}`
        );

        if (response.ok) {
          const data = await response.json();
          statusEl.textContent = 'Nano Banana Ready';
          statusEl.className = 'api-status ready';
          console.log('Connected to Nano Banana (Gemini 2.0 Flash):', data.displayName);
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || 'Invalid API key');
        }
      } catch (error) {
        statusEl.textContent = 'Error';
        statusEl.className = 'api-status error';
        showError('Nano Banana connection failed: ' + error.message);
      }
    }

    async function transformImage(prompt, style) {
      const apiKey = document.getElementById('apiKey').value;
      showLoading(style);

      try {
        // Get the original image as base64
        const originalImg = document.getElementById('originalImage');
        const imageUrl = originalImg.src;

        // Fetch image and convert to base64
        const imageResponse = await fetch(imageUrl);
        const blob = await imageResponse.blob();
        const base64Data = await blobToBase64(blob);

        // Extract just the base64 part (remove data:image/...;base64, prefix)
        const base64Only = base64Data.split(',')[1];

        // Use Nano Banana (Gemini 2.0 Flash) for style transfer with image generation
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  {
                    inlineData: {
                      mimeType: 'image/jpeg',
                      data: base64Only
                    }
                  },
                  {
                    text: `Transform this photograph into ${style.replace('-', ' ')} artistic style. ${prompt}. Generate a new image with this style applied. Output only the transformed image.`
                  }
                ]
              }],
              generationConfig: {
                responseModalities: ["TEXT", "IMAGE"],
                temperature: 0.8
              }
            })
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Nano Banana API error:', errorData);

          // Check if it's a specific error we can handle
          if (errorData.error?.message?.includes('not supported')) {
            showError('Image generation not available. Using demo mode.');
          }
          applyDemoFilter(style);
          hideLoading();
          return;
        }

        const data = await response.json();
        console.log('Nano Banana response:', data);

        // Extract generated image from response
        let imageFound = false;
        if (data.candidates && data.candidates[0]?.content?.parts) {
          for (const part of data.candidates[0].content.parts) {
            if (part.inlineData?.data) {
              const mimeType = part.inlineData.mimeType || 'image/png';
              const transformedSrc = `data:${mimeType};base64,${part.inlineData.data}`;
              document.getElementById('transformedImage').src = transformedSrc;
              document.getElementById('transformedImage').style.filter = 'none';
              imageFound = true;
              console.log('Nano Banana transformation successful!');
              break;
            }
          }
        }

        if (!imageFound) {
          console.log('No image in response, using CSS filter demo');
          applyDemoFilter(style);
        }

        hideLoading();

      } catch (error) {
        console.error('Transform error:', error);
        // Fall back to CSS filter demo
        applyDemoFilter(style);
        hideLoading();
      }
    }

    // Demo fallback using CSS filters to simulate style transfer
    function applyDemoFilter(style) {
      const img = document.getElementById('transformedImage');
      const filters = {
        'pop-art': 'saturate(2) contrast(1.3) brightness(1.1)',
        'watercolor': 'blur(0.5px) saturate(1.3) brightness(1.05)',
        'line-art': 'grayscale(1) contrast(2) brightness(1.2)',
        'oil-painting': 'saturate(1.5) contrast(1.2) brightness(0.95)',
        'romantic': 'sepia(0.3) saturate(1.2) brightness(1.1) contrast(0.95)',
        'comic-book': 'saturate(1.8) contrast(1.4) brightness(1.05)',
        'vintage': 'sepia(0.6) saturate(0.8) contrast(1.1) brightness(0.95)',
        'enhanced': 'saturate(1.2) contrast(1.1) brightness(1.05)'
      };
      img.style.filter = filters[style] || 'none';
      showError('Demo mode: Using CSS filters. For real AI transformation, Imagen API access is required.');
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
