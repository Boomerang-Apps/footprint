{
  "$schema": "../../planning/schemas/story-schema-v4.3.json",
  "schema_version": "4.3",
  "story_id": "FAV-01",
  "type": "feature",
  "wave_number": 9,
  "title": "Favorites Page — Persistent AI Creations Gallery",
  "domain": "frontend",
  "agent": "fe-dev",
  "priority": "P1",
  "story_points": 8,
  "description": "Create a standalone Favorites page where users can view all their hearted/saved AI creations that persist across sessions via localStorage. The MobileBottomNav already links to /favorites with a Heart icon but no page exists. Currently, 'hearted' versions in the style step are tied to the order session and lost on reset. This story extracts the STYLES UI config to a shared module, creates a Zustand favoritesStore with localStorage persistence, builds the /favorites page with a responsive grid of favorited creations, and integrates the heart toggle on the style page so favorites persist beyond the current order.",
  "status": "complete",
  "objective": {
    "as_a": "user who has created AI-transformed artwork",
    "i_want": "to save my favorite AI creations to a permanent collection and revisit them anytime",
    "so_that": "I can browse my saved creations later, compare them, and easily reorder or continue customizing them"
  },
  "acceptance_criteria": [
    {
      "id": "AC-01",
      "description": "Favorites page renders at /favorites route",
      "ears_format": "WHEN user navigates to /favorites THEN display the favorites gallery page with Hebrew header 'היצירות שלי' and subtitle 'יצירות ה-AI השמורות שלך'",
      "test_approach": "Render favorites page, verify heading text and subtitle present",
      "status": "passed"
    },
    {
      "id": "AC-02",
      "description": "Empty state when no favorites exist",
      "ears_format": "WHEN user has no saved favorites THEN display empty state with Heart icon, encouraging Hebrew text 'עדיין לא שמרת יצירות', and CTA button linking to /create",
      "test_approach": "Render page with empty store, verify empty state UI elements",
      "status": "passed"
    },
    {
      "id": "AC-03",
      "description": "Display favorites in responsive 2-column grid",
      "ears_format": "WHEN user has saved favorites THEN display them in a 2-column grid on mobile with image, style name, date, and action buttons",
      "test_approach": "Render page with mock favorites, verify grid layout and card contents",
      "status": "passed"
    },
    {
      "id": "AC-04",
      "description": "Each favorite card shows image with style gradient background",
      "ears_format": "WHEN favorite card renders THEN show the AI-transformed image with rounded corners and the style's gradient color as a decorative background accent",
      "test_approach": "Verify card renders image and correct gradient class for each style",
      "status": "passed"
    },
    {
      "id": "AC-05",
      "description": "Heart icon removes favorite on click",
      "ears_format": "WHEN user clicks the filled heart icon on a favorite card THEN remove that item from favorites and update the grid immediately",
      "test_approach": "Click heart on card, verify removeFavorite called and card disappears",
      "status": "passed"
    },
    {
      "id": "AC-06",
      "description": "Style name displayed in Hebrew",
      "ears_format": "WHEN favorite card renders THEN display the Hebrew style name from the shared STYLES config",
      "test_approach": "Render card with known style, verify Hebrew name displayed",
      "status": "passed"
    },
    {
      "id": "AC-07",
      "description": "Formatted creation date displayed",
      "ears_format": "WHEN favorite card renders THEN display creation date formatted in Hebrew locale",
      "test_approach": "Render card with known timestamp, verify formatted date output",
      "status": "passed"
    },
    {
      "id": "AC-08",
      "description": "'Use This' button loads image into order flow",
      "ears_format": "WHEN user clicks 'השתמש ביצירה' button on a favorite card THEN set originalImage and transformedImage in orderStore, set selectedStyle, and navigate to /create/style",
      "test_approach": "Click 'Use This' button, verify orderStore updated and router.push called with /create/style",
      "status": "passed"
    },
    {
      "id": "AC-09",
      "description": "Favorites persist across page refreshes via localStorage",
      "ears_format": "WHEN user refreshes the page or closes and reopens the browser THEN all previously saved favorites are still visible",
      "threshold": "localStorage key: footprint-favorites",
      "test_approach": "Add favorites, simulate rehydration, verify favorites restored from localStorage",
      "status": "passed"
    },
    {
      "id": "AC-10",
      "description": "Heart toggle on style page saves to favoritesStore",
      "ears_format": "WHEN user clicks the heart button on a transformed image in the style selection step THEN save the image to favoritesStore in addition to the existing orderStore savedVersions",
      "test_approach": "Mock favoritesStore, click heart on style page, verify addFavorite called with correct data",
      "status": "passed"
    },
    {
      "id": "AC-11",
      "description": "Heart state on style page reflects favoritesStore",
      "ears_format": "WHEN a transformed image is already in favoritesStore THEN show filled heart icon on the style page preview",
      "test_approach": "Pre-populate favoritesStore with matching imageUrl, verify filled heart rendered",
      "status": "passed"
    },
    {
      "id": "AC-12",
      "description": "STYLES config extracted to shared module",
      "ears_format": "WHEN style page or favorites page imports STYLES THEN both import from the same shared module at lib/ai/styles-ui.ts",
      "test_approach": "Verify both pages import STYLES from lib/ai/styles-ui, verify STYLES array has correct shape",
      "status": "passed"
    },
    {
      "id": "AC-13",
      "description": "RTL layout and Hebrew-first UI",
      "ears_format": "WHEN favorites page renders THEN all text is Hebrew, layout uses RTL logical properties, and content aligns correctly",
      "test_approach": "Verify dir='rtl' on container, verify Tailwind classes use start/end not left/right",
      "status": "passed"
    },
    {
      "id": "AC-14",
      "description": "Mobile bottom nav highlights favorites tab",
      "ears_format": "WHEN user is on /favorites THEN the Heart tab in MobileBottomNav shows active state",
      "test_approach": "Navigate to /favorites, verify MobileBottomNav heart icon has active class",
      "status": "passed"
    },
    {
      "id": "AC-15",
      "description": "Zustand favoritesStore with correct interface",
      "ears_format": "WHEN favoritesStore is created THEN it exposes addFavorite, removeFavorite, isFavorite, clearAll methods and persists favorites array to localStorage",
      "test_approach": "Unit test store: add, remove, check isFavorite, clearAll, verify localStorage interaction",
      "status": "passed"
    },
    {
      "id": "AC-16",
      "description": "Prevent duplicate favorites",
      "ears_format": "WHEN user tries to save an image that is already in favorites THEN do not add a duplicate entry",
      "test_approach": "Add same imageUrl twice, verify favorites.length === 1",
      "status": "passed"
    }
  ],
  "context": {
    "read_files": [
      "stores/orderStore.ts",
      "app/(app)/create/style/page.tsx",
      "components/ui/Card.tsx",
      "lib/ai/styles-ui.ts",
      "stores/favoritesStore.ts"
    ],
    "similar_implementations": [
      "stores/orderStore.ts",
      "app/(app)/create/style/page.tsx"
    ]
  },
  "execution": {
    "model_tier": "opus",
    "checkpoint_frequency": "per_gate",
    "parallel_with": ["AUTH-03"]
  },
  "subtasks": [
    {
      "id": "ST-01",
      "title": "Extract STYLES config to shared module",
      "description": "Move STYLES array and StyleOption interface from style page to lib/ai/styles-ui.ts",
      "status": "complete"
    },
    {
      "id": "ST-02",
      "title": "Create favoritesStore with Zustand persist",
      "description": "Create stores/favoritesStore.ts with addFavorite, removeFavorite, isFavorite, clearAll",
      "status": "complete"
    },
    {
      "id": "ST-03",
      "title": "Build favorites page",
      "description": "Create app/(app)/favorites/page.tsx with responsive grid, Hebrew UI, empty state",
      "status": "complete"
    },
    {
      "id": "ST-04",
      "title": "Integrate style page heart toggle",
      "description": "Connect heart button on style page to favoritesStore",
      "status": "complete"
    },
    {
      "id": "ST-05",
      "title": "Implement Use This flow",
      "description": "Wire up 'Use This' button to populate orderStore and navigate to /create/style",
      "status": "complete"
    }
  ],
  "files": {
    "create": [
      "stores/favoritesStore.ts",
      "stores/favoritesStore.test.ts",
      "lib/ai/styles-ui.ts",
      "lib/ai/styles-ui.test.ts",
      "app/(app)/favorites/page.tsx",
      "app/(app)/favorites/page.test.tsx"
    ],
    "modify": [
      "app/(app)/create/style/page.tsx"
    ],
    "forbidden": [
      "app/api/*",
      "lib/payments/*",
      "lib/supabase/*",
      "stores/orderStore.ts"
    ]
  },
  "design_source": {
    "type": "none",
    "verified": true,
    "verified_at": "2026-02-13T18:00:00Z"
  },
  "technical_requirements": {
    "reuse_components": [
      "components/ui/Card.tsx",
      "lucide-react: Heart, Sparkles, Plus, Trash2, ArrowRight"
    ],
    "reuse_patterns": {
      "zustand_persist": "Follow stores/orderStore.ts persist + partialize pattern",
      "id_generation": "Date.now() + Math.random().toString(36).substr(2, 9)"
    },
    "state_management": "Zustand with persist middleware, localStorage key: footprint-favorites"
  },
  "tdd": {
    "test_framework": "vitest",
    "test_files": [
      "stores/favoritesStore.test.ts",
      "lib/ai/styles-ui.test.ts",
      "app/(app)/favorites/page.test.tsx"
    ],
    "coverage_target": 90,
    "test_categories": [
      {
        "name": "FavoritesStore — Core Operations",
        "count": 7,
        "examples": [
          "should initialize with empty favorites array",
          "should add a favorite with generated id and timestamp",
          "should remove a favorite by id",
          "should not add duplicate favorites (same imageUrl)",
          "should clear all favorites"
        ]
      },
      {
        "name": "FavoritesStore — Persistence",
        "count": 3,
        "examples": [
          "should persist favorites to localStorage",
          "should rehydrate favorites from localStorage on init",
          "should handle corrupted localStorage gracefully"
        ]
      },
      {
        "name": "Styles UI Module",
        "count": 3,
        "examples": [
          "should export STYLES array with correct count",
          "should have correct shape for each StyleOption",
          "getStyleById should return correct style or undefined"
        ]
      },
      {
        "name": "Favorites Page — Rendering",
        "count": 5,
        "examples": [
          "should render page header with Hebrew title",
          "should show empty state when no favorites",
          "should render grid of favorite cards when favorites exist"
        ]
      },
      {
        "name": "Favorites Page — Interactions",
        "count": 4,
        "examples": [
          "should remove favorite when heart icon clicked",
          "should navigate to /create/style when 'Use This' clicked",
          "should update orderStore with favorite data on 'Use This'"
        ]
      },
      {
        "name": "Style Page — Favorites Integration",
        "count": 3,
        "examples": [
          "should call addFavorite when heart button clicked",
          "should show filled heart when image is already in favorites"
        ]
      }
    ],
    "mocking_strategy": {
      "store": "Create real Zustand store instance for unit tests",
      "router": "vi.mock('next/navigation') for page tests",
      "image": "vi.mock('next/image') — render as plain img",
      "localStorage": "Use vitest built-in localStorage mock"
    }
  },
  "safety": {
    "stop_conditions": [
      "Modification to orderStore.ts structure (read-only import allowed)",
      "Changes to payment or API routes",
      "Storing actual image binary data in localStorage"
    ],
    "escalation_triggers": [
      "localStorage usage exceeds 1MB for favorites data",
      "Build fails after style page modifications"
    ],
    "rollback_plan": "Remove favorites page route, revert style page heart button to order-only behavior, delete favoritesStore"
  },
  "hazard_analysis": {
    "identified_hazards": [
      {
        "id": "HAZ-001",
        "description": "localStorage quota exceeded with too many high-resolution image URLs",
        "severity": "minor",
        "likelihood": "remote",
        "mitigation": "Image URLs are references (not base64), so size is minimal. Add a max favorites limit (e.g., 50) as a safety cap."
      },
      {
        "id": "HAZ-002",
        "description": "'Use This' overwrites current in-progress order state",
        "severity": "major",
        "likelihood": "occasional",
        "mitigation": "Phase 1: overwrite directly (matches existing 'select version' behavior). Phase 2: show confirmation dialog."
      },
      {
        "id": "HAZ-003",
        "description": "Image URLs become stale (R2/CDN URLs expire or get deleted)",
        "severity": "minor",
        "likelihood": "occasional",
        "mitigation": "Show broken-image fallback UI. Phase 2: add image URL validation on page load."
      },
      {
        "id": "HAZ-004",
        "description": "Favorites lost when user clears browser data",
        "severity": "minor",
        "likelihood": "occasional",
        "mitigation": "Phase 2 will add Supabase sync for logged-in users. Phase 1: localStorage only, accepted limitation."
      }
    ],
    "risk_level": "low"
  },
  "dependencies": {
    "required_before": ["WAVE1-FE-002"],
    "blocks": ["FAV-02"]
  },
  "traceability": {
    "requirements": ["PRD-USER-EXPERIENCE", "PRD-ENGAGEMENT"],
    "epic": "FAVORITES",
    "related_stories": ["WAVE1-FE-002", "FAV-02"]
  },
  "output": {
    "files_created": [
      "stores/favoritesStore.ts",
      "stores/favoritesStore.test.ts",
      "lib/ai/styles-ui.ts",
      "lib/ai/styles-ui.test.ts",
      "app/(app)/favorites/page.tsx",
      "app/(app)/favorites/page.test.tsx"
    ],
    "files_modified": [
      "app/(app)/create/style/page.tsx"
    ],
    "tests_passing": true,
    "coverage_achieved": 90,
    "pr_description": "feat(FAV-01): Favorites page — persistent AI creations gallery with localStorage"
  },
  "validation": {
    "lint_command": "pnpm lint",
    "test_command": "pnpm test:run",
    "build_command": "pnpm build",
    "type_check_command": "pnpm type-check"
  },
  "gates_completed": ["gate-0", "gate-1", "gate-2", "gate-3", "gate-7"],
  "estimated_tests": 25,
  "metadata": {
    "created_at": "2026-02-13T12:00:00Z",
    "created_by": "claude-opus-4-6",
    "updated_at": "2026-02-14T15:00:00Z"
  },
  "notes": "All 6 created files and 1 modified file are on main. 25 tests across favoritesStore (10), styles-ui (6), and favorites page (9+). 3391 tests passing at completion. Phase 2 deferred to FAV-02 (Supabase sync for logged-in users)."
}
