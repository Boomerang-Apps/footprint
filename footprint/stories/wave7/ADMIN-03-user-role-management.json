{
  "$schema": "../../../planning/schemas/story-schema-v4.2.json",
  "schema_version": "4.2",
  "story_id": "ADMIN-03",
  "type": "feature",
  "wave_number": 7,
  "title": "Admin User Role Management",
  "domain": "backend",
  "agent": "be-dev",
  "priority": "high",
  "story_points": 3,
  "description": "Create API endpoints for managing user roles (promote to admin, demote to user) and account status (activate/deactivate)",
  "status": "pending",

  "objective": {
    "as_a": "Footprint admin",
    "i_want": "to manage user roles and account status",
    "so_that": "I can control access and moderate the platform"
  },

  "acceptance_criteria": [
    {
      "id": "AC-001",
      "description": "PATCH /api/admin/users/[id]/role updates user admin status",
      "ears_format": "WHEN admin calls PATCH /api/admin/users/{id}/role with {isAdmin: true} THEN update user's is_admin field in database",
      "test_approach": "Send isAdmin=true, verify database updated"
    },
    {
      "id": "AC-002",
      "description": "Endpoint requires admin role authentication",
      "ears_format": "WHEN non-admin calls role endpoint THEN return 403; WHEN unauthenticated THEN return 401",
      "test_approach": "Test without auth (401), regular user (403), admin (200)"
    },
    {
      "id": "AC-003",
      "description": "Admin cannot demote themselves",
      "ears_format": "WHEN admin attempts to set own isAdmin=false THEN return 400 with error 'לא ניתן להסיר הרשאות מעצמך'",
      "test_approach": "Try to set own isAdmin=false, expect 400 error"
    },
    {
      "id": "AC-004",
      "description": "Returns 404 for non-existent user",
      "ears_format": "WHEN admin updates role for non-existent user ID THEN return 404 with error 'משתמש לא נמצא'",
      "test_approach": "Try to update invalid UUID, expect 404"
    },
    {
      "id": "AC-005",
      "description": "PATCH /api/admin/users/[id]/status updates account status",
      "ears_format": "WHEN admin calls PATCH /api/admin/users/{id}/status with {status: 'inactive'} THEN update user status in database",
      "test_approach": "Send status='inactive', verify database updated"
    },
    {
      "id": "AC-006",
      "description": "Deactivating user logs them out of all sessions",
      "ears_format": "WHEN user is deactivated THEN invalidate all active sessions via Supabase admin API",
      "test_approach": "Mock Supabase admin API, verify signOut called"
    },
    {
      "id": "AC-007",
      "description": "Admin cannot deactivate themselves",
      "ears_format": "WHEN admin attempts to deactivate own account THEN return 400 with error 'לא ניתן להשבית את החשבון שלך'",
      "test_approach": "Try to deactivate own account, expect 400 error"
    },
    {
      "id": "AC-008",
      "description": "Status change is logged in audit table",
      "ears_format": "WHEN user role or status changes THEN create entry in admin_audit_log with actor, target, action, timestamp",
      "test_approach": "Change status, verify audit log entry created"
    },
    {
      "id": "AC-009",
      "description": "Response includes updated user object",
      "ears_format": "WHEN role/status update succeeds THEN return {success: true, user: UpdatedUserObject}",
      "test_approach": "Verify response contains updated user data"
    },
    {
      "id": "AC-010",
      "description": "All endpoints apply rate limiting",
      "ears_format": "WHEN request rate exceeds limit THEN return 429 Too Many Requests",
      "threshold": "rate: 20/min",
      "test_approach": "Mock rate limiter, verify checkRateLimit called"
    }
  ],

  "files": {
    "create": [
      "app/api/admin/users/[id]/role/route.ts",
      "app/api/admin/users/[id]/role/route.test.ts",
      "app/api/admin/users/[id]/status/route.ts",
      "app/api/admin/users/[id]/status/route.test.ts"
    ],
    "modify": [],
    "forbidden": [
      "app/api/profile/route.ts",
      "lib/auth/admin.ts",
      "supabase/migrations/*"
    ]
  },

  "technical_requirements": {
    "reuse_components": [
      "lib/supabase/server.ts - createClient()",
      "lib/supabase/admin.ts - admin client for session invalidation",
      "lib/rate-limit.ts - checkRateLimit()"
    ],
    "database_tables": [
      "profiles",
      "admin_audit_log"
    ],
    "api_endpoints": [
      { "method": "PATCH", "path": "/api/admin/users/:id/role", "description": "Update user admin status" },
      { "method": "PATCH", "path": "/api/admin/users/:id/status", "description": "Update user account status" }
    ],
    "response_format": {
      "role_update": {
        "success": "boolean",
        "user": {
          "id": "string",
          "email": "string",
          "isAdmin": "boolean",
          "updatedAt": "string"
        }
      },
      "status_update": {
        "success": "boolean",
        "user": {
          "id": "string",
          "email": "string",
          "status": "'active' | 'inactive' | 'suspended'",
          "updatedAt": "string"
        }
      }
    }
  },

  "tdd": {
    "test_framework": "vitest",
    "test_files": [
      "app/api/admin/users/[id]/role/route.test.ts",
      "app/api/admin/users/[id]/status/route.test.ts"
    ],
    "coverage_target": 90,
    "test_categories": [
      {
        "name": "Authentication",
        "count": 4,
        "examples": [
          "should return 401 when not authenticated",
          "should return 403 for non-admin users",
          "should return 200 for admin users (role)",
          "should return 200 for admin users (status)"
        ]
      },
      {
        "name": "Role Management",
        "count": 4,
        "examples": [
          "should promote user to admin",
          "should demote admin to user",
          "should prevent self-demotion",
          "should return 404 for non-existent user"
        ]
      },
      {
        "name": "Status Management",
        "count": 4,
        "examples": [
          "should deactivate user account",
          "should reactivate user account",
          "should prevent self-deactivation",
          "should log out deactivated user"
        ]
      },
      {
        "name": "Audit Logging",
        "count": 2,
        "examples": [
          "should log role changes",
          "should log status changes"
        ]
      },
      {
        "name": "Rate Limiting",
        "count": 2,
        "examples": [
          "should apply rate limiting",
          "should return 429 when rate limited"
        ]
      },
      {
        "name": "Error Handling",
        "count": 2,
        "examples": [
          "should return 500 on database error",
          "should return 400 for invalid input"
        ]
      }
    ],
    "mocking_strategy": {
      "supabase": "vi.mock('@/lib/supabase/server')",
      "supabase_admin": "vi.mock('@/lib/supabase/admin')",
      "rate_limit": "vi.mock('@/lib/rate-limit')"
    }
  },

  "hazard_analysis": {
    "identified_hazards": [
      {
        "id": "HAZ-001",
        "description": "Unauthorized privilege escalation",
        "severity": "catastrophic",
        "likelihood": "remote",
        "mitigation": "Verify current user is admin before any role change, double-check with Supabase RLS"
      },
      {
        "id": "HAZ-002",
        "description": "Admin locks themselves out",
        "severity": "critical",
        "likelihood": "occasional",
        "mitigation": "Prevent self-demotion and self-deactivation with explicit checks"
      },
      {
        "id": "HAZ-003",
        "description": "Session not properly invalidated on deactivation",
        "severity": "critical",
        "likelihood": "remote",
        "mitigation": "Use Supabase admin API to force sign out, verify in tests"
      },
      {
        "id": "HAZ-004",
        "description": "Audit trail missing for security-critical actions",
        "severity": "major",
        "likelihood": "remote",
        "mitigation": "Mandatory audit log entry before returning success response"
      }
    ],
    "risk_level": "high"
  },

  "safety": {
    "stop_conditions": [
      "Any modification to authentication middleware",
      "Changes to customer-facing endpoints",
      "Database schema changes"
    ],
    "escalation_triggers": [
      "Role escalation vulnerabilities",
      "Unauthorized privilege changes",
      "Session invalidation failures"
    ],
    "rollback_plan": "Delete new role/status API endpoint files"
  },

  "dependencies": {
    "required_before": ["ADMIN-02"],
    "blocks": []
  },

  "traceability": {
    "requirements": ["PRD-ADMIN-USER-MGMT", "SEC-ROLE-MGMT"],
    "epic": "ADMIN-USERS",
    "related_stories": ["ADMIN-01", "ADMIN-02", "ADMIN-04"]
  },

  "metadata": {
    "created_at": "2026-02-01T12:00:00Z",
    "created_by": "claude-opus-4-5"
  },

  "estimated_tests": 18
}
