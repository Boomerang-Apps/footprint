{
  "$schema": "../../planning/schemas/story-schema-v4.3.json",
  "schema_version": "4.3",
  "story_id": "CO-06",
  "type": "feature",
  "wave_number": 8,
  "title": "PayPlus Israeli Payment Integration",
  "domain": "backend",
  "agent": "be-dev",
  "priority": "P0",
  "story_points": 13,
  "description": "Complete integration with PayPlus payment gateway for Israeli credit card processing. Core payment flow (session creation, redirect, webhook verification, callbacks, ILS currency, idempotency, test mode, PCI compliance) was implemented in CO-01/CO-02. This story covers the 4 remaining gaps: payment record persistence (AC-007), refund processing (AC-008/009), webhook IP whitelisting (AC-014), and pending order timeout handling (AC-011).",
  "status": "complete",
  "objective": {
    "as_a": "Israeli customer",
    "i_want": "to pay securely with my local credit card",
    "so_that": "I can complete purchases using familiar payment methods"
  },
  "acceptance_criteria": [
    {
      "id": "AC-01",
      "description": "Initialize PayPlus payment session",
      "ears_format": "WHEN checkout initiated THEN create PayPlus payment page session with order details",
      "test_approach": "Mock PayPlus API, verify session creation request",
      "status": "passed"
    },
    {
      "id": "AC-02",
      "description": "Redirect to PayPlus hosted page",
      "ears_format": "WHEN payment session created THEN redirect customer to PayPlus hosted payment page",
      "test_approach": "Verify redirect URL generated correctly",
      "status": "passed"
    },
    {
      "id": "AC-03",
      "description": "Handle successful payment callback",
      "ears_format": "WHEN PayPlus sends success callback THEN verify signature, update order status to paid, record transaction",
      "test_approach": "Mock callback with valid signature, verify order updated",
      "status": "passed"
    },
    {
      "id": "AC-04",
      "description": "Handle failed payment callback",
      "ears_format": "WHEN PayPlus sends failure callback THEN update order status to payment_failed, show error to customer",
      "test_approach": "Mock failure callback, verify error handling",
      "status": "passed"
    },
    {
      "id": "AC-05",
      "description": "Signature verification",
      "ears_format": "WHEN callback received THEN verify HMAC signature using secret key, reject invalid signatures",
      "test_approach": "Test with valid and invalid signatures",
      "status": "passed"
    },
    {
      "id": "AC-06",
      "description": "Support Israeli Shekel currency",
      "ears_format": "WHEN payment created THEN use ILS currency code with amounts in agorot",
      "test_approach": "Verify currency and amount format in API request",
      "status": "passed"
    },
    {
      "id": "AC-07",
      "description": "Store transaction record",
      "ears_format": "WHEN payment succeeds THEN store transaction_id, approval_number, last_4_digits, card_brand in payments table",
      "test_approach": "Verify payment record created with required fields",
      "status": "passed"
    },
    {
      "id": "AC-08",
      "description": "Process refunds",
      "ears_format": "WHEN admin initiates refund THEN call PayPlus refund API, update payment status to refunded",
      "test_approach": "Mock refund API, verify refund processing",
      "status": "passed"
    },
    {
      "id": "AC-09",
      "description": "Partial refund support",
      "ears_format": "WHEN admin initiates partial refund THEN specify amount and create partial refund record",
      "test_approach": "Test partial refund with various amounts",
      "status": "passed"
    },
    {
      "id": "AC-10",
      "description": "Handle duplicate callbacks",
      "ears_format": "WHEN duplicate callback received THEN idempotently skip if already processed",
      "test_approach": "Send same callback twice, verify no duplicate processing",
      "status": "passed"
    },
    {
      "id": "AC-11",
      "description": "Timeout handling",
      "ears_format": "WHEN payment page times out THEN expire order after 15 minutes, allow retry",
      "threshold": "timeout: 15min",
      "test_approach": "Simulate timeout, verify order status",
      "status": "passed"
    },
    {
      "id": "AC-12",
      "description": "Test mode support",
      "ears_format": "WHEN PAYPLUS_SANDBOX is true THEN use sandbox credentials and test card numbers",
      "test_approach": "Verify test mode configuration",
      "status": "passed"
    },
    {
      "id": "AC-13",
      "description": "PCI compliance",
      "ears_format": "WHEN payment processed THEN never store full card number, CVV, or track data on our servers",
      "test_approach": "Audit stored data, verify no PCI scope data",
      "status": "passed"
    },
    {
      "id": "AC-14",
      "description": "Webhook endpoint security",
      "ears_format": "WHEN webhook endpoint called THEN only accept requests from PayPlus IP whitelist",
      "test_approach": "Test with allowed and blocked IPs",
      "status": "passed"
    }
  ],
  "context": {
    "read_files": [
      "lib/payments/payplus.ts",
      "lib/payments/payplus.test.ts",
      "app/api/webhooks/payplus/route.ts",
      "app/api/orders/[id]/finalize/route.ts",
      "types/database.ts",
      "lib/auth/admin.ts",
      "lib/rate-limit.ts"
    ],
    "similar_implementations": [
      "lib/payments/payplus.ts"
    ]
  },
  "execution": {
    "model_tier": "opus",
    "checkpoint_frequency": "per_gate"
  },
  "files": {
    "create": [
      "lib/payments/record.ts",
      "lib/payments/record.test.ts",
      "lib/payments/refund.ts",
      "lib/payments/refund.test.ts",
      "lib/payments/ip-whitelist.ts",
      "lib/payments/ip-whitelist.test.ts",
      "app/api/admin/orders/[id]/refund/route.ts",
      "app/api/admin/orders/[id]/refund/route.test.ts",
      "app/api/cron/expire-pending-orders/route.ts",
      "app/api/cron/expire-pending-orders/route.test.ts"
    ],
    "modify": [
      "app/api/webhooks/payplus/route.ts",
      "app/api/orders/[id]/finalize/route.ts",
      "vercel.json"
    ],
    "forbidden": [
      "stores/orderStore.ts",
      "components/*"
    ]
  },
  "design_source": {
    "type": "none"
  },
  "technical_requirements": {
    "api_endpoints": [
      "POST /api/admin/orders/[id]/refund",
      "GET /api/cron/expire-pending-orders"
    ],
    "database_tables": [
      "payments",
      "orders"
    ],
    "reuse_components": [
      "lib/payments/payplus.ts",
      "lib/auth/admin.ts",
      "lib/rate-limit.ts",
      "lib/supabase/server.ts"
    ],
    "reuse_patterns": {
      "never_throws": "All payment services return { success, error?, data? } result objects",
      "idempotent_writes": "Check-then-insert for payment records",
      "timing_safe": "crypto.timingSafeEqual for secret comparison"
    },
    "state_management": "Server-side only, Supabase DB"
  },
  "tdd": {
    "test_framework": "vitest",
    "test_files": [
      "lib/payments/record.test.ts",
      "lib/payments/refund.test.ts",
      "lib/payments/ip-whitelist.test.ts",
      "app/api/admin/orders/[id]/refund/route.test.ts",
      "app/api/cron/expire-pending-orders/route.test.ts"
    ],
    "coverage_target": 95,
    "test_categories": [
      {
        "name": "Payment Records",
        "count": 8,
        "examples": [
          "should create payment record with all fields",
          "should be idempotent on duplicate external_transaction_id",
          "should not throw on database errors (returns error result)"
        ]
      },
      {
        "name": "Refund Service",
        "count": 8,
        "examples": [
          "should call correct PayPlus refund API URL",
          "should convert agorot to ILS before sending",
          "should handle network errors gracefully"
        ]
      },
      {
        "name": "Admin Refund Endpoint",
        "count": 14,
        "examples": [
          "should return 401 for unauthenticated requests",
          "should return 403 for non-admin users",
          "should process full refund and update statuses",
          "should process partial refund with negative record"
        ]
      },
      {
        "name": "IP Whitelisting",
        "count": 10,
        "examples": [
          "should match exact IP address",
          "should match IP within CIDR range",
          "should allow all when whitelist is empty"
        ]
      },
      {
        "name": "Expire Pending Orders Cron",
        "count": 7,
        "examples": [
          "should return 401 for invalid CRON_SECRET",
          "should expire orders older than 15 minutes",
          "should only expire orders with status pending"
        ]
      }
    ],
    "mocking_strategy": {
      "payplus_api": "vi.mock global fetch for PayPlus API calls",
      "database": "vi.mock('@/lib/supabase/server') — mock createAdminClient()",
      "admin_auth": "vi.mock('@/lib/auth/admin') — mock verifyAdmin()",
      "rate_limit": "vi.mock('@/lib/rate-limit') — mock checkRateLimit()"
    }
  },
  "safety": {
    "stop_conditions": [
      "Any suspected fraudulent transaction patterns",
      "API credential compromise",
      "PCI compliance violation",
      "Payment record failures exceeding 1% of transactions"
    ],
    "escalation_triggers": [
      "Payment success rate < 90%",
      "Webhook failure rate > 1%",
      "Any refund dispute",
      "Cron job failing to run for > 30 minutes"
    ],
    "rollback_plan": "Disable PayPlus integration, show 'Payment temporarily unavailable' message. For refund endpoint: disable route. For cron: remove from vercel.json crons config."
  },
  "hazard_analysis": {
    "identified_hazards": [
      {
        "id": "HAZ-001",
        "description": "Payment processed but order not updated",
        "severity": "critical",
        "likelihood": "remote",
        "mitigation": "Idempotent webhook processing, reconciliation job, payment status dashboard"
      },
      {
        "id": "HAZ-002",
        "description": "Duplicate charge to customer",
        "severity": "critical",
        "likelihood": "remote",
        "mitigation": "Idempotency key in payment session, order-payment one-to-one constraint"
      },
      {
        "id": "HAZ-003",
        "description": "Refund processed to wrong customer",
        "severity": "critical",
        "likelihood": "remote",
        "mitigation": "Admin-only refund endpoint, transaction ID verification, audit log"
      },
      {
        "id": "HAZ-004",
        "description": "API credentials exposed",
        "severity": "critical",
        "likelihood": "remote",
        "mitigation": "Environment variables only, never log credentials, secret rotation"
      },
      {
        "id": "HAZ-005",
        "description": "Payment record insert fails silently, losing transaction data",
        "severity": "major",
        "likelihood": "remote",
        "mitigation": "Payment record failure is caught and logged but must NOT break order processing. Webhook payload stored for reconciliation."
      },
      {
        "id": "HAZ-006",
        "description": "Cron job expires order that was actually paid (race condition)",
        "severity": "critical",
        "likelihood": "remote",
        "mitigation": "Only expire orders with status=pending. Webhook/finalize always checks current status before update. 15-minute timeout provides ample buffer."
      }
    ],
    "risk_level": "high"
  },
  "dependencies": {
    "required_before": ["CO-01", "CO-02"],
    "blocks": []
  },
  "traceability": {
    "requirements": ["PRD-PAYMENTS", "PRD-CHECKOUT"],
    "epic": "PAYMENTS",
    "related_stories": ["CO-01", "CO-02", "CO-03", "CO-04"]
  },
  "output": {
    "files_created": [
      "lib/payments/record.ts",
      "lib/payments/record.test.ts",
      "lib/payments/refund.ts",
      "lib/payments/refund.test.ts",
      "lib/payments/ip-whitelist.ts",
      "lib/payments/ip-whitelist.test.ts",
      "app/api/admin/orders/[id]/refund/route.ts",
      "app/api/admin/orders/[id]/refund/route.test.ts",
      "app/api/cron/expire-pending-orders/route.ts",
      "app/api/cron/expire-pending-orders/route.test.ts"
    ],
    "files_modified": [
      "app/api/webhooks/payplus/route.ts",
      "app/api/orders/[id]/finalize/route.ts",
      "vercel.json",
      "lib/rate-limit.ts"
    ],
    "tests_passing": true,
    "coverage_achieved": 95,
    "pr_description": "feat(CO-06): PayPlus full integration — payment records, refunds, IP whitelist & timeouts"
  },
  "validation": {
    "lint_command": "pnpm lint",
    "test_command": "pnpm test:run",
    "build_command": "pnpm build",
    "type_check_command": "pnpm type-check"
  },
  "gates_completed": ["gate-0", "gate-1", "gate-2", "gate-3", "gate-4", "gate-7"],
  "estimated_tests": 63,
  "metadata": {
    "created_at": "2026-02-01T21:00:00Z",
    "created_by": "claude-opus-4-5",
    "updated_at": "2026-02-14T16:00:00Z"
  },
  "notes": "PR #24 merged to main (commit 304ccc1). 14 ACs all passing. 49 new tests written across 5 test files. Security hardened: timing-safe cron secret, HTTPS enforcement on refund URL, integer validation + 100K ILS cap on refund amount, finalize requires succeeded payment record from webhook. Operational: set PAYPLUS_WEBHOOK_IPS and CRON_SECRET env vars in Vercel production."
}
